<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chronos Protocol - AI Longevity Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            carbon: '#0A0C10',
            sage: '#B4E33D',
            amber: '#F59E0B',
          },
          letterSpacing: {
            'wide': '0.05em',
            'wider': '0.1em',
            'widest': '0.15em',
          },
        },
      },
    }
  </script>
  <style>
    @keyframes pulse-subtle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .animate-pulse-subtle {
      animation: pulse-subtle 1.5s ease-in-out infinite;
    }
    @keyframes lift {
      from { transform: translateY(0); }
      to { transform: translateY(-4px); }
    }
    .glass {
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(180, 227, 61, 0.08);
      border-color: rgba(180, 227, 61, 0.2);
    }
    .sparkline {
      stroke: #B4E33D;
      fill: none;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .protocol-checkbox {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 1.5px solid rgba(180, 227, 61, 0.4);
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    .protocol-checkbox:hover {
      border-color: #B4E33D;
      background: rgba(180, 227, 61, 0.08);
    }
    .protocol-checkbox:checked {
      background: #B4E33D url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230A0C10' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 12l5 5L20 7'/%3E%3C/svg%3E") center / 12px no-repeat;
      border-color: #B4E33D;
    }
    .protocol-item .protocol-label {
      transition: color 0.2s ease, text-decoration 0.2s ease;
    }
    .protocol-item.checked .protocol-label {
      text-decoration: line-through;
      color: #B4E33D;
    }
    #compliance-ring {
      transition: stroke-dashoffset 0.4s ease;
    }
  </style>
</head>
<body class="bg-carbon text-white font-sans antialiased min-h-screen" style="letter-spacing: 0.02em;">
  <div class="min-h-screen">
    <!-- Bio-Clock Header -->
    <header class="border-b border-white/10 bg-carbon/80 backdrop-blur-sm sticky top-0 z-50">
      <div class="max-w-[1600px] mx-auto px-6 md:px-10 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-8">
            <span class="text-white/60 text-xs font-medium tracking-wider">Member: <span id="member-name" class="text-white">—</span></span>
            <span class="text-white/60 text-xs font-medium tracking-wider">Protocol Status: <span id="protocol-status" class="text-sage">—</span></span>
          </div>
          <div class="text-xs text-white/40 tracking-widest font-light">CHRONOS</div>
        </div>
      </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-[1600px] mx-auto px-6 md:px-10 py-10 md:py-16">
      <div class="space-y-10">
        <!-- Primary Metric Card - Biological Age with Line Chart -->
        <section>
          <div class="glass rounded-2xl p-8 md:p-12 card-hover">
            <div class="flex items-start justify-between mb-8">
              <div>
                <h2 class="text-white/50 text-xs font-medium tracking-widest uppercase mb-3">Biological Age</h2>
                <div class="flex items-baseline gap-3">
                  <span class="text-7xl md:text-8xl font-light text-white tabular-nums" style="letter-spacing: -0.02em;">34.2</span>
                  <span class="text-white/40 text-xl font-light">years</span>
                </div>
                <div class="flex items-center gap-2 mt-4">
                  <svg class="w-4 h-4 text-sage" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                  <span class="text-sage font-medium text-sm tracking-wide">-3.8 years reversal</span>
                </div>
              </div>
            </div>
            
            <!-- High-fidelity Line Chart -->
            <div class="mt-8">
              <div class="h-48 md:h-64 relative">
                <svg viewBox="0 0 800 200" class="w-full h-full" preserveAspectRatio="none">
                  <!-- Grid lines -->
                  <defs>
                    <linearGradient id="ageGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" style="stop-color:#B4E33D;stop-opacity:0.2" />
                      <stop offset="100%" style="stop-color:#B4E33D;stop-opacity:0" />
                    </linearGradient>
                  </defs>
                  <!-- Background grid -->
                  <g opacity="0.1">
                    <line x1="0" y1="50" x2="800" y2="50" stroke="white" stroke-width="0.5" />
                    <line x1="0" y1="100" x2="800" y2="100" stroke="white" stroke-width="0.5" />
                    <line x1="0" y1="150" x2="800" y2="150" stroke="white" stroke-width="0.5" />
                  </g>
                  <!-- Area under curve -->
                  <path d="M 0 180 Q 100 170 200 160 T 400 140 T 600 120 T 800 100 L 800 200 L 0 200 Z" fill="url(#ageGradient)" />
                  <!-- Main trend line (declining/reversing) -->
                  <path d="M 0 180 Q 100 170 200 160 T 400 140 T 600 120 T 800 100" 
                        stroke="#B4E33D" 
                        stroke-width="3" 
                        fill="none" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"
                        class="sparkline" />
                  <!-- Data points -->
                  <circle cx="0" cy="180" r="4" fill="#B4E33D" />
                  <circle cx="200" cy="160" r="4" fill="#B4E33D" />
                  <circle cx="400" cy="140" r="4" fill="#B4E33D" />
                  <circle cx="600" cy="120" r="4" fill="#B4E33D" />
                  <circle cx="800" cy="100" r="5" fill="#B4E33D" />
                </svg>
              </div>
              <div class="flex items-center justify-between mt-4 text-xs text-white/40">
                <span>6 months ago</span>
                <span>Today</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Clean Data Cards with Sparklines -->
        <section>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- HRV Card -->
            <div class="glass rounded-xl p-6 card-hover">
              <div class="flex items-center justify-between mb-4">
                <span class="text-white/40 text-xs font-medium tracking-widest uppercase">HRV</span>
                <span class="w-1.5 h-1.5 rounded-full bg-sage animate-pulse-subtle"></span>
              </div>
              <div class="flex items-end justify-between">
                <div>
                  <div id="hrv-value" class="text-4xl font-light text-white tabular-nums mb-1">—</div>
                  <div class="text-white/40 text-xs font-light">ms</div>
                </div>
                <div class="flex-1 ml-6 h-12">
                  <svg viewBox="0 0 120 40" class="w-full h-full" preserveAspectRatio="none">
                    <path d="M 0 30 Q 15 25 30 28 T 60 26 T 90 24 T 120 22" 
                          class="sparkline" 
                          opacity="0.8" />
                  </svg>
                </div>
              </div>
              <div class="mt-4 pt-4 border-t border-white/10">
                <span id="hrv-status" class="text-sage text-xs font-medium tracking-wide">—</span>
              </div>
            </div>

            <!-- Sleep Score Card -->
            <div class="glass rounded-xl p-6 card-hover">
              <div class="flex items-center justify-between mb-4">
                <span class="text-white/40 text-xs font-medium tracking-widest uppercase">Sleep Score</span>
                <span class="w-1.5 h-1.5 rounded-full bg-sage animate-pulse-subtle"></span>
              </div>
              <div class="flex items-end justify-between">
                <div>
                  <div id="sleep-value" class="text-4xl font-light text-white tabular-nums mb-1">—</div>
                  <div class="text-white/40 text-xs font-light">score</div>
                </div>
                <div class="flex-1 ml-6 h-12">
                  <svg viewBox="0 0 120 40" class="w-full h-full" preserveAspectRatio="none">
                    <path d="M 0 35 L 20 32 L 40 28 L 60 25 L 80 22 L 100 20 L 120 18" 
                          class="sparkline" 
                          opacity="0.8" />
                  </svg>
                </div>
              </div>
              <div class="mt-4 pt-4 border-t border-white/10">
                <span id="sleep-status" class="text-sage text-xs font-medium tracking-wide">—</span>
              </div>
            </div>

            <!-- Cortisol Card -->
            <div class="glass rounded-xl p-6 card-hover">
              <div class="flex items-center justify-between mb-4">
                <span class="text-white/40 text-xs font-medium tracking-widest uppercase">Cortisol</span>
                <span class="w-1.5 h-1.5 rounded-full bg-amber animate-pulse-subtle"></span>
              </div>
              <div class="flex items-end justify-between">
                <div>
                  <div class="text-4xl font-light text-white tabular-nums mb-1">12.3</div>
                  <div class="text-white/40 text-xs font-light">μg/dL</div>
                </div>
                <div class="flex-1 ml-6 h-12">
                  <svg viewBox="0 0 120 40" class="w-full h-full" preserveAspectRatio="none">
                    <path d="M 0 20 Q 20 18 40 19 T 80 21 T 120 22" 
                          class="sparkline" 
                          stroke="#F59E0B"
                          opacity="0.8" />
                  </svg>
                </div>
              </div>
              <div class="mt-4 pt-4 border-t border-white/10">
                <span class="text-amber text-xs font-medium tracking-wide">Monitor</span>
              </div>
            </div>
          </div>
        </section>

        <!-- AI Clinical Engine Box -->
        <section>
          <div class="glass rounded-2xl p-8 md:p-10 card-hover">
            <h3 class="text-white/50 text-xs font-medium tracking-widest uppercase mb-6">Autonomous Intelligence Feed</h3>
            <div class="glass rounded-xl p-8 md:p-10 border border-white/10">
              <div class="space-y-6">
                <!-- STATUS -->
                <div id="status-section" class="opacity-0">
                  <div class="flex items-center gap-3 mb-1">
                    <span class="text-white/60 text-xs font-medium tracking-widest uppercase">STATUS:</span>
                    <span class="w-2 h-2 rounded-full bg-sage animate-pulse-subtle"></span>
                  </div>
                  <p id="status-text" class="text-[#E5E7EB] text-base font-light leading-relaxed ml-0">Optimal Baseline</p>
                </div>

                <!-- INSIGHT -->
                <div id="insight-section" class="opacity-0">
                  <div class="mb-1">
                    <span class="text-white/60 text-xs font-medium tracking-widest uppercase">INSIGHT:</span>
                  </div>
                  <p id="insight-text" class="text-[#E5E7EB] text-base font-light leading-relaxed ml-0">HRV (68ms) indicates high neural readiness. Deep sleep recovery is prioritized.</p>
                </div>

                <!-- DIRECTIVE -->
                <div id="directive-section" class="opacity-0">
                  <div class="mb-1">
                    <span class="text-white/60 text-xs font-medium tracking-widest uppercase">DIRECTIVE:</span>
                  </div>
                  <p id="directive-text" class="text-sage text-base font-light leading-relaxed ml-0"></p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Daily Protocol Execution -->
        <section class="relative">
          <div class="glass rounded-2xl p-8 md:p-10 card-hover">
            <div class="absolute top-6 right-6 md:top-8 md:right-8" aria-hidden="true">
              <div class="relative w-14 h-14">
                <svg class="w-14 h-14 -rotate-90" viewBox="0 0 36 36">
                  <path class="text-white/10" stroke="currentColor" stroke-width="2.5" fill="none" d="M18 2.5 a 15.5 15.5 0 0 1 0 31 a 15.5 15.5 0 0 1 0 -31" />
                  <path id="compliance-ring" class="text-sage" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" fill="none" stroke-dasharray="97.4" stroke-dashoffset="97.4" d="M18 2.5 a 15.5 15.5 0 0 1 0 31 a 15.5 15.5 0 0 1 0 -31" />
                </svg>
                <span id="compliance-text" class="absolute inset-0 flex items-center justify-center text-[10px] font-medium text-white/80 tabular-nums">0/0</span>
              </div>
            </div>
            <h3 class="text-white/50 text-xs font-medium tracking-widest uppercase mb-6 pr-16">Daily Protocol Execution</h3>
            <ul id="protocol-list" class="space-y-4"></ul>
            <p id="protocol-empty-state" class="hidden mt-6 text-sage/80 text-sm font-light tracking-wide">Protocol Fully Executed. Biological Optimization Peak.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function() {
      var statusSection = document.getElementById('status-section');
      var insightSection = document.getElementById('insight-section');
      var directiveSection = document.getElementById('directive-section');

      /**
       * Extracts display names from supplement_stack (objects or strings).
       */
      function supplementNames(stack) {
        if (!stack || !stack.length) return [];
        return stack.map(function(item) {
          return typeof item === 'string' ? item : (item.name || '');
        }).filter(Boolean);
      }

      /**
       * Generates directive from biometrics (HRV rules) and optional supplement_stack.
       * Direct-Action tone.
       */
      function generateAIInstruction(biometrics, supplement_stack) {
        var hrv = biometrics && typeof biometrics.hrv === 'number' ? biometrics.hrv : null;
        var names = supplementNames(supplement_stack);
        var stackStr = names.length ? ' Maintain stack: ' + names.join(', ') + '.' : '';

        if (hrv !== null && hrv < 50) {
          return 'Recovery Focus: Switch to Zone 2 or Yoga. Increase Magnesium to 400mg tonight.' + stackStr;
        }
        if (hrv !== null && hrv > 70) {
          return 'High Output: Neural readiness is peak. Proceed with High-Intensity training.' + stackStr;
        }
        return 'Maintain protocol. Proceed with moderate intensity. Keep current supplement stack.' + stackStr;
      }

      function fadeIn(element, delay) {
        setTimeout(function() {
          element.style.transition = 'opacity 0.8s ease-out, transform 0.8s ease-out';
          element.style.opacity = '1';
          element.style.transform = 'translateY(0)';
        }, delay);
      }

      function initFromBioContext() {
        [statusSection, insightSection, directiveSection].forEach(function(el) {
          el.style.transform = 'translateY(10px)';
        });
        fadeIn(statusSection, 600);
        fadeIn(insightSection, 1000);
        fadeIn(directiveSection, 1400);
      }

      /**
       * Normalize supplement_stack to { name, time?, completed }.
       * Supports both [{"name","status","time"}] and ["NMN 500mg", ...].
       */
      function normalizeSupplementStack(raw) {
        if (!raw || !raw.length) return [];
        return raw.map(function(item, i) {
          if (typeof item === 'string') {
            return { id: i, name: item, time: '', completed: false };
          }
          var name = item.name || ('Supplement ' + (i + 1));
          var completed = item.status === 'completed';
          return { id: i, name: name, time: item.time || '', completed: completed };
        });
      }

      /**
       * Render Daily Protocol Execution list, wire checkboxes, compliance ring, empty state.
       */
      function renderProtocolExecution(stack) {
        var listEl = document.getElementById('protocol-list');
        var emptyEl = document.getElementById('protocol-empty-state');
        var ringEl = document.getElementById('compliance-ring');
        var textEl = document.getElementById('compliance-text');
        if (!listEl) return;

        var items = normalizeSupplementStack(stack);
        listEl.innerHTML = '';

        function updateCompliance() {
          var completed = items.filter(function(x) { return x.completed; }).length;
          var total = items.length;
          var pct = total ? Math.round((completed / total) * 100) : 0;
          var circumference = 97.4;
          var offset = circumference - (pct / 100) * circumference;
          if (ringEl) {
            ringEl.setAttribute('stroke-dasharray', circumference);
            ringEl.setAttribute('stroke-dashoffset', offset);
          }
          if (textEl) textEl.textContent = completed + '/' + total;
          if (emptyEl) {
            emptyEl.classList.toggle('hidden', !(total && completed === total));
          }
        }

        items.forEach(function(item) {
          var li = document.createElement('li');
          li.className = 'protocol-item flex items-center gap-3' + (item.completed ? ' checked' : '');
          li.dataset.id = item.id;

          var label = document.createElement('label');
          label.className = 'flex items-center gap-3 cursor-pointer flex-1';

          var cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'protocol-checkbox';
          cb.checked = item.completed;

          var span = document.createElement('span');
          span.className = 'protocol-label text-white/90 font-light';
          span.textContent = item.name;

          label.appendChild(cb);
          label.appendChild(span);
          if (item.time) {
            var timeSpan = document.createElement('span');
            timeSpan.className = 'text-white/40 text-xs font-light';
            timeSpan.textContent = item.time;
            label.appendChild(timeSpan);
          }
          li.appendChild(label);

          cb.addEventListener('change', function() {
            item.completed = cb.checked;
            li.classList.toggle('checked', cb.checked);
            updateCompliance();
          });

          listEl.appendChild(li);
        });

        updateCompliance();
      }

      /**
       * Load Chronos engine: read biometrics, apply HRV/Sleep logic, update UI.
       */
      function loadChronosEngine(data) {
        var bio = data.biometrics || {};
        var hrv = typeof bio.hrv === 'number' ? bio.hrv : null;
        var sleepScore = typeof bio.sleep_score === 'number' ? bio.sleep_score : null;
        var stack = data.supplement_stack || [];

        var memberEl = document.getElementById('member-name');
        var statusEl = document.getElementById('protocol-status');
        var statusText = document.getElementById('status-text');
        var insightText = document.getElementById('insight-text');
        var directiveText = document.getElementById('directive-text');
        var hrvValueEl = document.getElementById('hrv-value');
        var hrvStatusEl = document.getElementById('hrv-status');
        var sleepValueEl = document.getElementById('sleep-value');
        var sleepStatusEl = document.getElementById('sleep-status');

        if (memberEl) memberEl.textContent = data.member || '—';
        if (statusEl) statusEl.textContent = data.current_regimen || 'Optimal';
        if (statusText) statusText.textContent = (data.current_regimen || 'Protocol Alpha') + ' · Optimal Baseline';

        if (hrvValueEl) hrvValueEl.textContent = hrv !== null ? String(hrv) : '—';
        if (hrvStatusEl) {
          if (hrv !== null && hrv < 50) hrvStatusEl.textContent = 'Recovery Focus';
          else if (hrv !== null && hrv > 70) hrvStatusEl.textContent = 'High Output';
          else hrvStatusEl.textContent = 'Optimal Range';
        }

        if (sleepValueEl) sleepValueEl.textContent = sleepScore !== null ? String(sleepScore) : '—';
        if (sleepStatusEl) {
          sleepStatusEl.textContent = sleepScore !== null && sleepScore < 70 ? 'Compromised' : 'Recovery Optimized';
        }

        var insightParts = [];
        if (hrv !== null) {
          insightParts.push('HRV (' + hrv + 'ms) ' + (hrv < 50 ? 'indicates recovery mode.' : hrv > 70 ? 'indicates peak neural readiness.' : 'indicates high neural readiness.'));
        }
        insightParts.push('Deep sleep recovery ' + (sleepScore !== null && sleepScore < 70 ? 'needs attention.' : 'is prioritized.'));
        if (sleepScore !== null && sleepScore < 70) {
          insightParts.push('Analysis: Sleep architecture compromised. Limit blue light after 8 PM.');
        }
        if (insightText) insightText.textContent = insightParts.join(' ');

        var directive = generateAIInstruction(bio, stack);
        if (directiveText) directiveText.textContent = directive;

        renderProtocolExecution(stack);
        initFromBioContext();
      }

      fetch('friend1-context.json')
        .then(function(res) { return res.ok ? res.json() : Promise.reject(new Error('Failed to load friend1-context')); })
        .then(loadChronosEngine)
        .catch(function(err) {
          console.warn('Friend1-context unavailable:', err);
          loadChronosEngine({
            member: 'Santhosh',
            current_regimen: 'Optimal',
            biometrics: { hrv: 68, sleep_score: 75 },
            supplement_stack: []
          });
        });
    })();
  </script>
</body>
</html>
